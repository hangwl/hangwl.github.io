import{j as n,r as l}from"./index-895OKoX5.js";import{c as pe,d as Y,A as me,D as xe,G as we,h as te,f as B,B as q,g as V,i as ve,e as ye,V as _,W as ke,j as be}from"./three.module-BMpVVWHP.js";function je({score:e,hasStarted:t,running:r,gameOver:c,viewMode:f,onCycleView:j,isFullscreen:p,onToggleFullscreen:o}){return n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"absolute top-3 left-3 z-50 text-sm text-white pointer-events-none",children:["Score: ",e]}),n.jsxs("div",{className:"absolute top-3 right-3 z-[60] flex items-center gap-2",children:[n.jsxs("button",{className:"pointer-events-auto rounded-full border border-white/20 bg-white/10 text-white backdrop-blur-sm w-9 h-9 flex items-center justify-center hover:bg-white/20 active:scale-95 cursor-pointer",onClick:j,title:"Toggle camera view (Chase/First/2D)","aria-label":"Toggle view",children:[f==="top"&&n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("polygon",{points:"3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21 3 6"}),n.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"18"}),n.jsx("line",{x1:"15",y1:"6",x2:"15",y2:"21"})]}),f==="first"&&n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("circle",{cx:"12",cy:"8",r:"3"}),n.jsx("path",{d:"M6 20c0-3.314 2.686-6 6-6s6 2.686 6 6"})]}),f==="chase"&&n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"}),n.jsx("circle",{cx:"12",cy:"12",r:"3"})]})]}),n.jsx("button",{className:"pointer-events-auto rounded-full border border-white/20 bg-white/10 text-white backdrop-blur-sm w-9 h-9 flex items-center justify-center hover:bg-white/20 active:scale-95 cursor-pointer",onClick:o,title:p?"Exit fullscreen":"Enter fullscreen","aria-label":p?"Exit fullscreen":"Enter fullscreen",children:p?n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("polyline",{points:"4 14 10 14 10 20"}),n.jsx("polyline",{points:"20 10 14 10 14 4"}),n.jsx("line",{x1:"14",y1:"10",x2:"21",y2:"3"}),n.jsx("line",{x1:"3",y1:"21",x2:"10",y2:"14"})]}):n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M15 3h6v6"}),n.jsx("path",{d:"M21 3l-7 7"}),n.jsx("path",{d:"M9 21H3v-6"}),n.jsx("path",{d:"M3 21l7-7"})]})})]}),!t&&!c&&n.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center pointer-events-none",children:n.jsx("p",{className:"text-white/80 text-3xl sm:text-4xl font-bold tracking-widest",children:"START"})}),!r&&t&&!c&&n.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center pointer-events-none",children:n.jsx("span",{className:"text-white/80 text-3xl sm:text-4xl font-bold tracking-widest",children:"PAUSED"})}),c&&n.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center pointer-events-none",children:n.jsx("span",{className:"text-white/80 text-3xl sm:text-4xl font-bold tracking-widest",children:"GAME OVER"})}),(!r||!t||c)&&n.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-50 pointer-events-none",children:n.jsx("div",{className:"mx-auto rounded-md bg-black/40 text-white/90 backdrop-blur px-3 py-2 w-fit max-w-[92vw] min-w-[300px] sm:min-w-[360px]",children:n.jsxs("div",{className:"text-[11px] sm:text-xs flex flex-col items-center gap-y-1",children:[n.jsxs("div",{className:"flex justify-center gap-x-3 whitespace-nowrap",children:[n.jsx("span",{children:"[← / A] turn left"}),n.jsx("span",{children:"[→ / D] turn right"})]}),n.jsxs("div",{className:"flex flex-wrap justify-center gap-x-3",children:[!c&&n.jsx("span",{children:t?n.jsxs(n.Fragment,{children:["[Space] ",r?"pause":"resume"]}):n.jsx(n.Fragment,{children:"[Space] start"})}),n.jsx("span",{children:"[R] restart"}),n.jsx("span",{children:"[V] toggle view"})]})]})})})]})}const Re=l.forwardRef(function({height:t,show2D:r,onCanvasClick:c,miniCanvasRef:f,containerRef:j},p){return n.jsxs("div",{ref:j,className:"relative overflow-hidden w-full",style:{height:t},children:[n.jsx("div",{ref:p,className:`absolute inset-0 z-0 ${r?"opacity-0 pointer-events-none":""}`}),r&&n.jsx("canvas",{ref:f,className:"absolute inset-0 z-0 bg-black"}),n.jsx("button",{type:"button",className:"absolute inset-0 z-40 bg-transparent cursor-pointer",onClick:c})]})});function X(e){const t={x:Math.floor(e.cols/2),y:Math.floor(e.rows/2)};return{snake:[t,{x:t.x-1,y:t.y},{x:t.x-2,y:t.y}],dir:{x:1,y:0},pendingDir:{x:1,y:0},food:{x:10,y:10},score:0,running:!1,hasStarted:!1,gameOver:!1}}function ne(e){return{x:e.y,y:-e.x}}function se(e){return{x:-e.y,y:e.x}}function I(e,t){for(;;){const r={x:Math.floor(Math.random()*t.cols),y:Math.floor(Math.random()*t.rows)};if(!e.snake.some(c=>c.x===r.x&&c.y===r.y)){e.food=r;return}}}function ge(e,t){e.dir=e.pendingDir;const r={...e.snake[0]};return r.x+=e.dir.x,r.y+=e.dir.y,r.x<0||r.y<0||r.x>=t.cols||r.y>=t.rows?(e.gameOver=!0,e.running=!1,"hitWall"):e.snake.some(c=>c.x===r.x&&c.y===r.y)?(e.gameOver=!0,e.running=!1,"hitSelf"):(e.snake=[r,...e.snake],r.x===e.food.x&&r.y===e.food.y?(e.score+=1,I(e,t),"ate"):(e.snake.pop(),"ok"))}function Me(e){const t=new pe;t.background=new Y("#0b0b0b");const r=new me(16777215,.5);t.add(r);const c=new xe(16777215,1);c.position.set(5,10,7),t.add(c);const f=new we(e.rows*e.cell,e.rows,2236962,1776411);f.position.set((e.cols-1)*e.cell/2,0,(e.rows-1)*e.cell/2),t.add(f);const j=new te,p=new B({color:3881787,metalness:.1,roughness:.9}),o=.8,h=(M,R,z,A)=>{const T=new q(M,o,R),D=new V(T,p);D.position.set(z,o/2,A),j.add(D)},v=e.cols*e.cell,s=e.rows*e.cell;h(v+.2,.2,(v-e.cell)/2,-e.cell/2),h(v+.2,.2,(v-e.cell)/2,(e.rows-.5)*e.cell),h(.2,s+.2,-e.cell/2,(s-e.cell)/2),h(.2,s+.2,(e.cols-.5)*e.cell,(s-e.cell)/2),t.add(j);const x=new te;t.add(x);const w=new q(.9*e.cell,.9*e.cell,.9*e.cell),b=new B({color:new Y("#22c55e"),metalness:0,roughness:1}),y=new V(w,b);t.add(y);const m=new ve(.4*e.cell,24,16),k=new B({color:15680580,metalness:.2,roughness:.4}),H=new V(m,k);return t.add(H),{scene:t,snakeGroup:x,headMesh:y,foodMesh:H,cleanup:()=>{t.traverse(M=>{const R=M;R.isMesh&&(R.geometry?.dispose?.(),Array.isArray(R.material)?R.material.forEach(z=>z.dispose()):R.material?.dispose?.())}),t.clear()}}}function Ce(e){const t=new ye(70,1,.01,100);return t.position.set(0,e.camHeight,0),t.up.set(0,1,0),t}function Se(e,t){const r=new _,c=new _,f=1.5,j=3,p=1,o=h=>new _(h.x*t.cell,t.camHeight,h.y*t.cell);return{reset(h){const v=o(h);r.copy(v),c.copy(v)},update(h,v,s,x){const w=o(h),b=new _(v.x,0,v.y).normalize(),y=new _(0,1,0);let m=w.clone(),k=w.clone();if(s==="chase"){const z=b.clone().multiplyScalar(-.8*t.cell),A=y.clone().multiplyScalar(f*t.cell);m.add(z).add(A),k.copy(w),k.add(b.clone().multiplyScalar(j*t.cell)),k.y+=.5*t.cell}else s==="first"?(m.y=t.camHeight,k.add(b.clone().multiplyScalar(p*t.cell))):(m.copy(w),k.copy(w));const H=s==="first"?.2:.1,W=s==="first"?.5:.1,M=1-Math.pow(1-H,x*60),R=1-Math.pow(1-W,x*60);r.lerp(m,M),c.lerp(k,R),e.position.copy(r),s==="top"?e.up.set(0,0,-1):e.up.set(0,1,0),e.lookAt(c)}}}function re(e,t){const r={ctx:e.getContext("2d"),pad:12,cell:6,offX:0,offY:0,w:0,h:0};function c(p,o){e.width=p,e.height=o,r.w=p,r.h=o;const h=Math.max(20,Math.min(44,Math.round(Math.min(p,o)*.065)));r.pad=h;const v=Math.max(0,p-2*h),s=Math.max(0,o-2*h),x=Math.max(2,Math.floor(Math.min(v/t.cols,s/t.rows))),w=t.cols*x,b=t.rows*x;r.cell=x,r.offX=h+Math.floor((v-w)/2),r.offY=h+Math.floor((s-b)/2)}function f(p){const o=r.ctx;if(!o)return;const{w:h,h:v,cell:s,offX:x,offY:w}=r;o.clearRect(0,0,h,v),o.fillStyle="#0b0b0b",o.fillRect(0,0,h,v),o.fillStyle="#0e0e10",o.fillRect(x,w,t.cols*s,t.rows*s),o.strokeStyle="rgba(255,255,255,0.08)",o.lineWidth=1;for(let y=0;y<=t.cols;y++){const m=x+y*s+.5;o.beginPath(),o.moveTo(m,w),o.lineTo(m,w+t.rows*s),o.stroke()}for(let y=0;y<=t.rows;y++){const m=w+y*s+.5;o.beginPath(),o.moveTo(x,m),o.lineTo(x+t.cols*s,m),o.stroke()}o.fillStyle="#ef4444",o.fillRect(x+p.food.x*s,w+p.food.y*s,s,s),o.fillStyle="#22c55e",p.snake.forEach((y,m)=>{m!==0&&o.fillRect(x+y.x*s+1,w+y.y*s+1,s-2,s-2)});const b=p.snake[0];b&&(o.fillStyle="#22c55e",o.fillRect(x+b.x*s,w+b.y*s,s,s))}function j(){}return{resize:c,render:f,dispose:j}}function Ee(e){const t=l.useRef(null),r=l.useRef(null),[c,f]=l.useState(()=>X(e)),[j,p]=l.useState("chase"),o=l.useRef("chase");l.useEffect(()=>{o.current=j},[j]);const[h,v]=l.useState(520),s=l.useRef(c);l.useEffect(()=>{s.current=c},[c]);const x=l.useRef(!1),w=l.useRef(!1),b=l.useRef(!1),y=l.useRef(0);l.useEffect(()=>{x.current=c.running},[c.running]),l.useEffect(()=>{w.current=c.hasStarted},[c.hasStarted]),l.useEffect(()=>{const a=b.current;b.current=c.gameOver,!a&&c.gameOver&&(y.current=performance.now())},[c.gameOver]);const m=l.useRef(null),k=l.useRef(null),H=l.useRef(null),W=l.useRef(null),M=l.useRef(null),R=l.useRef(null),z=100,A=l.useRef(0),T=l.useRef(0),D=l.useCallback((a,u)=>{const d=t.current;let i=m.current;if(!i){i=new ke({antialias:!0}),i.setPixelRatio(Math.min(window.devicePixelRatio,2)),i.outputColorSpace=be,d.appendChild(i.domElement),m.current=i;const C=i.domElement;C.style.position="absolute",C.style.inset="0",C.style.width="100%",C.style.height="100%"}i.setSize(a,u);const L=i.domElement;L.style.width="100%",L.style.height="100%"},[]),oe=l.useCallback(()=>{const a=t.current,u=H.current;if(!a||!u)return;let d=a.clientWidth;!d&&a.parentElement&&(d=a.parentElement.clientWidth);const i=.62;if(!!document.fullscreenElement){const S=Math.max(1,window.innerHeight),O=Math.max(1,window.innerWidth);u.aspect=O/S,u.updateProjectionMatrix(),D(O,S),v(S),r.current&&E.current?.resize(O,S);return}const C=Math.min(560,Math.floor(window.innerHeight*.8)),g=Math.max(320,Math.min(C,Math.round(d*i)));u.aspect=d/g,u.updateProjectionMatrix(),D(d,g),v(g),r.current&&E.current?.resize(d,g)},[D]),E=l.useRef(null),U=l.useCallback(()=>{f(()=>{const a=X(e);I(a,e);const u=a.snake[0];return W.current?.reset(u),A.current=0,T.current=performance.now(),a})},[e]);l.useEffect(()=>{if(o.current!=="top")return;const a=r.current,u=t.current;if(!a||!u)return;E.current?.dispose&&E.current.dispose(),E.current=re(a,e);let d=u.clientWidth;!d&&u.parentElement&&(d=u.parentElement.clientWidth),E.current.resize(d,h),E.current.render(s.current)},[e,h,j]),l.useEffect(()=>{const a=u=>{const d=u.key.toLowerCase();if(d===" "){u.preventDefault(),f(i=>i.gameOver?i:i.hasStarted?{...i,running:!i.running}:{...i,hasStarted:!0,running:!0});return}if(d==="r"){const i=performance.now();if(b.current&&i-y.current<1e3)return;U();return}d==="arrowleft"||d==="a"?f(i=>({...i,pendingDir:ne(i.dir)})):d==="arrowright"||d==="d"?f(i=>({...i,pendingDir:se(i.dir)})):d==="v"&&(p(i=>i==="chase"?"first":i==="first"?"top":"chase"),u.preventDefault())};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[U]),l.useEffect(()=>{const a=t.current;if(!a)return;const u=Me(e);k.current=u,M.current=new q(.8*e.cell,.8*e.cell,.8*e.cell),R.current=new B({color:new Y("#22c55e"),metalness:0,roughness:1});const d=Ce(e);H.current=d;const i=Se(d,e);W.current=i,D(a.clientWidth,520),r.current&&(E.current=re(r.current,e));const L=()=>oe();L(),window.addEventListener("resize",L),document.addEventListener("fullscreenchange",L),f(g=>{const S={...g};return I(S,e),i.reset(S.snake[0]),S});let C=0;const K=g=>{C=requestAnimationFrame(K);const S=m.current,O=H.current,{scene:ue,snakeGroup:G,headMesh:J,foodMesh:fe}=k.current,he=T.current||g,de=Math.max(0,(g-he)/1e3);T.current=g;const P=s.current;if(P.running&&P.hasStarted&&!P.gameOver&&g-A.current>=z){A.current=g;const F={...P,snake:[...P.snake]};ge(F,e),s.current=F,f(F)}const Q=s.current.food;fe.position.set(Q.x*e.cell,e.camHeight,Q.y*e.cell);const Z=s.current.snake[0];if(Z&&W.current?.update(Z,s.current.dir,o.current,de),M.current&&R.current){const F=Math.max(0,s.current.snake.length-1);for(;G.children.length<F;){const N=new V(M.current,R.current);G.add(N)}for(;G.children.length>F;){const N=G.children.pop();N.geometry=new q(0,0,0)}for(let N=1;N<s.current.snake.length;N++){const ee=s.current.snake[N];G.children[N-1].position.set(ee.x*e.cell,.8*e.cell/2,ee.y*e.cell)}}const $=s.current.snake[0];$&&(J.position.set($.x*e.cell,.9*e.cell/2,$.y*e.cell),J.visible=o.current!=="first"),o.current==="top"&&E.current?.render(s.current),S.render(ue,O)};return C=requestAnimationFrame(K),()=>{cancelAnimationFrame(C),window.removeEventListener("resize",L),document.removeEventListener("fullscreenchange",L),m.current?.dispose(),u.cleanup();const g=t.current;g&&m.current&&g.removeChild(m.current.domElement),m.current=null,M.current?.dispose(),M.current=null,R.current?.dispose(),R.current=null}},[e]);const ce=l.useCallback(()=>{const a=performance.now();b.current&&a-y.current<1e3||f(u=>{if(u.gameOver){const d=X(e);return I(d,e),d}return u.hasStarted?{...u,running:!u.running}:{...u,hasStarted:!0,running:!0}})},[e]),le=l.useCallback(()=>f(a=>({...a,pendingDir:ne(a.dir)})),[]),ae=l.useCallback(()=>f(a=>({...a,pendingDir:se(a.dir)})),[]),ie=l.useCallback(()=>p(a=>a==="chase"?"first":a==="first"?"top":"chase"),[]);return{mountRef:t,miniCanvasRef:r,state:c,setState:f,viewMode:j,setViewMode:p,canvasH:h,onCanvasClick:ce,onTurnLeft:le,onTurnRight:ae,onCycleView:ie}}function ze(){const e=l.useMemo(()=>({cols:20,rows:20,cell:1.2,camHeight:.5}),[]),{mountRef:t,miniCanvasRef:r,state:c,viewMode:f,canvasH:j,onCanvasClick:p,onTurnLeft:o,onTurnRight:h,onCycleView:v}=Ee(e),s=c.running&&c.hasStarted&&!c.gameOver,x=l.useRef(null),w=l.useRef(null),[b,y]=l.useState(!1);l.useEffect(()=>{const k=()=>y(!!document.fullscreenElement);return document.addEventListener("fullscreenchange",k),()=>document.removeEventListener("fullscreenchange",k)},[]);const m=async()=>{try{if(document.fullscreenElement)document.exitFullscreen&&await document.exitFullscreen();else{const k=x.current||w.current||document.documentElement;k&&k.requestFullscreen&&await k.requestFullscreen()}}catch(k){console.warn("Fullscreen toggle failed",k)}};return n.jsx("div",{className:"space-y-3",children:n.jsxs("div",{ref:x,className:"relative",style:b?{width:"100vw",height:"100dvh"}:void 0,children:[n.jsx(Re,{height:j,show2D:f==="top",onCanvasClick:p,ref:t,miniCanvasRef:r,containerRef:w}),n.jsx(je,{score:c.score,hasStarted:c.hasStarted,running:c.running,gameOver:c.gameOver,viewMode:f,onCycleView:v,isFullscreen:b,onToggleFullscreen:m}),n.jsxs("div",{className:`absolute inset-0 pointer-events-none ${s?"z-50":"z-0"}`,children:[n.jsx("div",{className:`absolute left-0 top-0 bottom-0 bg-transparent cursor-pointer ${s?"pointer-events-auto":"pointer-events-none"}`,style:{width:"25%"},onClick:o}),n.jsx("div",{className:`absolute right-0 top-0 bottom-0 bg-transparent cursor-pointer ${s?"pointer-events-auto":"pointer-events-none"}`,style:{width:"25%"},onClick:h})]})]})})}export{ze as default};
