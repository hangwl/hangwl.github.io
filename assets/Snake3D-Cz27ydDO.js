import{j as n,r as l}from"./index-1jHvJRAh.js";import{c as xe,d as J,A as we,D as ve,G as ye,h as oe,f as V,B as K,g as I,i as ke,e as be,V as B,W as je,j as Re}from"./three.module-IZi7MB6m.js";function ge({score:e,hasStarted:t,running:r,gameOver:c,viewMode:h,onCycleView:j,isFullscreen:p,onToggleFullscreen:o}){return n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"absolute top-3 left-3 z-50 text-sm text-white pointer-events-none",children:["Score: ",e]}),n.jsxs("div",{className:"absolute top-3 right-3 z-[60] flex items-center gap-2",children:[n.jsxs("button",{className:"pointer-events-auto rounded-full border border-white/20 bg-white/10 text-white backdrop-blur-sm w-9 h-9 flex items-center justify-center hover:bg-white/20 active:scale-95 cursor-pointer",onClick:j,title:"Toggle camera view (Chase/First/2D)","aria-label":"Toggle view",children:[h==="top"&&n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("polygon",{points:"3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21 3 6"}),n.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"18"}),n.jsx("line",{x1:"15",y1:"6",x2:"15",y2:"21"})]}),h==="first"&&n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("circle",{cx:"12",cy:"8",r:"3"}),n.jsx("path",{d:"M6 20c0-3.314 2.686-6 6-6s6 2.686 6 6"})]}),h==="chase"&&n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"}),n.jsx("circle",{cx:"12",cy:"12",r:"3"})]})]}),n.jsx("button",{className:"pointer-events-auto rounded-full border border-white/20 bg-white/10 text-white backdrop-blur-sm w-9 h-9 flex items-center justify-center hover:bg-white/20 active:scale-95 cursor-pointer",onClick:o,title:p?"Exit fullscreen":"Enter fullscreen","aria-label":p?"Exit fullscreen":"Enter fullscreen",children:p?n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("polyline",{points:"4 14 10 14 10 20"}),n.jsx("polyline",{points:"20 10 14 10 14 4"}),n.jsx("line",{x1:"14",y1:"10",x2:"21",y2:"3"}),n.jsx("line",{x1:"3",y1:"21",x2:"10",y2:"14"})]}):n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M15 3h6v6"}),n.jsx("path",{d:"M21 3l-7 7"}),n.jsx("path",{d:"M9 21H3v-6"}),n.jsx("path",{d:"M3 21l7-7"})]})})]}),!t&&!c&&n.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center pointer-events-none",children:n.jsx("p",{className:"text-white/80 text-3xl sm:text-4xl font-bold tracking-widest",children:"START"})}),!r&&t&&!c&&n.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center pointer-events-none",children:n.jsx("span",{className:"text-white/80 text-3xl sm:text-4xl font-bold tracking-widest",children:"PAUSED"})}),c&&n.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center pointer-events-none",children:n.jsx("span",{className:"text-white/80 text-3xl sm:text-4xl font-bold tracking-widest",children:"GAME OVER"})}),(!r||!t||c)&&n.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-50 pointer-events-none",children:n.jsx("div",{className:"mx-auto rounded-md bg-black/40 text-white/90 backdrop-blur px-3 py-2 w-fit max-w-[92vw] min-w-[300px] sm:min-w-[360px]",children:n.jsxs("div",{className:"text-[11px] sm:text-xs flex flex-col items-center gap-y-1",children:[n.jsxs("div",{className:"flex justify-center gap-x-3 whitespace-nowrap",children:[n.jsx("span",{children:"[← / A] turn left"}),n.jsx("span",{children:"[→ / D] turn right"})]}),n.jsxs("div",{className:"flex flex-wrap justify-center gap-x-3",children:[!c&&n.jsx("span",{children:t?n.jsxs(n.Fragment,{children:["[Space] ",r?"pause":"resume"]}):n.jsx(n.Fragment,{children:"[Space] start"})}),n.jsx("span",{children:"[R] restart"}),n.jsx("span",{children:"[V] toggle view"})]})]})})})]})}const Me=l.forwardRef(function({height:t,show2D:r,onCanvasClick:c,miniCanvasRef:h,containerRef:j},p){return n.jsxs("div",{ref:j,className:"relative overflow-hidden w-full",style:{height:t},children:[n.jsx("div",{ref:p,className:`absolute inset-0 z-0 ${r?"opacity-0 pointer-events-none":""}`}),r&&n.jsx("canvas",{ref:h,className:"absolute inset-0 z-0 bg-black"}),n.jsx("button",{type:"button",className:"absolute inset-0 z-40 bg-transparent cursor-pointer",onClick:c})]})});function U(e){const t={x:Math.floor(e.cols/2),y:Math.floor(e.rows/2)};return{snake:[t,{x:t.x-1,y:t.y},{x:t.x-2,y:t.y}],dir:{x:1,y:0},pendingDir:{x:1,y:0},food:{x:10,y:10},score:0,running:!1,hasStarted:!1,gameOver:!1}}function ce(e){return{x:e.y,y:-e.x}}function le(e){return{x:-e.y,y:e.x}}function q(e,t){for(;;){const r={x:Math.floor(Math.random()*t.cols),y:Math.floor(Math.random()*t.rows)};if(!e.snake.some(c=>c.x===r.x&&c.y===r.y)){e.food=r;return}}}function Ce(e,t){e.dir=e.pendingDir;const r={...e.snake[0]};return r.x+=e.dir.x,r.y+=e.dir.y,r.x<0||r.y<0||r.x>=t.cols||r.y>=t.rows?(e.gameOver=!0,e.running=!1,"hitWall"):e.snake.some(c=>c.x===r.x&&c.y===r.y)?(e.gameOver=!0,e.running=!1,"hitSelf"):(e.snake=[r,...e.snake],r.x===e.food.x&&r.y===e.food.y?(e.score+=1,q(e,t),"ate"):(e.snake.pop(),"ok"))}function Se(e){const t=new xe;t.background=new J("#0b0b0b");const r=new we(16777215,.5);t.add(r);const c=new ve(16777215,1);c.position.set(5,10,7),t.add(c);const h=new ye(e.rows*e.cell,e.rows,2236962,1776411);h.position.set((e.cols-1)*e.cell/2,0,(e.rows-1)*e.cell/2),t.add(h);const j=new oe,p=new V({color:3881787,metalness:.1,roughness:.9}),o=.8,d=(M,R,S,E)=>{const L=new K(M,o,R),H=new I(L,p);H.position.set(S,o/2,E),j.add(H)},v=e.cols*e.cell,s=e.rows*e.cell;d(v+.2,.2,(v-e.cell)/2,-e.cell/2),d(v+.2,.2,(v-e.cell)/2,(e.rows-.5)*e.cell),d(.2,s+.2,-e.cell/2,(s-e.cell)/2),d(.2,s+.2,(e.cols-.5)*e.cell,(s-e.cell)/2),t.add(j);const x=new oe;t.add(x);const w=new K(.9*e.cell,.9*e.cell,.9*e.cell),b=new V({color:new J("#22c55e"),metalness:0,roughness:1}),y=new I(w,b);t.add(y);const m=new ke(.4*e.cell,24,16),k=new V({color:15680580,metalness:.2,roughness:.4}),F=new I(m,k);return t.add(F),{scene:t,snakeGroup:x,headMesh:y,foodMesh:F,cleanup:()=>{t.traverse(M=>{var S,E,L,H;const R=M;R.isMesh&&((E=(S=R.geometry)==null?void 0:S.dispose)==null||E.call(S),Array.isArray(R.material)?R.material.forEach($=>$.dispose()):(H=(L=R.material)==null?void 0:L.dispose)==null||H.call(L))}),t.clear()}}}function Ee(e){const t=new be(70,1,.01,100);return t.position.set(0,e.camHeight,0),t.up.set(0,1,0),t}function Le(e,t){const r=new B,c=new B,h=1.5,j=3,p=1,o=d=>new B(d.x*t.cell,t.camHeight,d.y*t.cell);return{reset(d){const v=o(d);r.copy(v),c.copy(v)},update(d,v,s,x){const w=o(d),b=new B(v.x,0,v.y).normalize(),y=new B(0,1,0);let m=w.clone(),k=w.clone();if(s==="chase"){const S=b.clone().multiplyScalar(-.8*t.cell),E=y.clone().multiplyScalar(h*t.cell);m.add(S).add(E),k.copy(w),k.add(b.clone().multiplyScalar(j*t.cell)),k.y+=.5*t.cell}else s==="first"?(m.y=t.camHeight,k.add(b.clone().multiplyScalar(p*t.cell))):(m.copy(w),k.copy(w));const F=s==="first"?.2:.1,G=s==="first"?.5:.1,M=1-Math.pow(1-F,x*60),R=1-Math.pow(1-G,x*60);r.lerp(m,M),c.lerp(k,R),e.position.copy(r),s==="top"?e.up.set(0,0,-1):e.up.set(0,1,0),e.lookAt(c)}}}function ae(e,t){const r={ctx:e.getContext("2d"),pad:12,cell:6,offX:0,offY:0,w:0,h:0};function c(p,o){e.width=p,e.height=o,r.w=p,r.h=o;const d=Math.max(20,Math.min(44,Math.round(Math.min(p,o)*.065)));r.pad=d;const v=Math.max(0,p-2*d),s=Math.max(0,o-2*d),x=Math.max(2,Math.floor(Math.min(v/t.cols,s/t.rows))),w=t.cols*x,b=t.rows*x;r.cell=x,r.offX=d+Math.floor((v-w)/2),r.offY=d+Math.floor((s-b)/2)}function h(p){const o=r.ctx;if(!o)return;const{w:d,h:v,cell:s,offX:x,offY:w}=r;o.clearRect(0,0,d,v),o.fillStyle="#0b0b0b",o.fillRect(0,0,d,v),o.fillStyle="#0e0e10",o.fillRect(x,w,t.cols*s,t.rows*s),o.strokeStyle="rgba(255,255,255,0.08)",o.lineWidth=1;for(let y=0;y<=t.cols;y++){const m=x+y*s+.5;o.beginPath(),o.moveTo(m,w),o.lineTo(m,w+t.rows*s),o.stroke()}for(let y=0;y<=t.rows;y++){const m=w+y*s+.5;o.beginPath(),o.moveTo(x,m),o.lineTo(x+t.cols*s,m),o.stroke()}o.fillStyle="#ef4444",o.fillRect(x+p.food.x*s,w+p.food.y*s,s,s),o.fillStyle="#22c55e",p.snake.forEach((y,m)=>{m!==0&&o.fillRect(x+y.x*s+1,w+y.y*s+1,s-2,s-2)});const b=p.snake[0];b&&(o.fillStyle="#22c55e",o.fillRect(x+b.x*s,w+b.y*s,s,s))}function j(){}return{resize:c,render:h,dispose:j}}function He(e){const t=l.useRef(null),r=l.useRef(null),[c,h]=l.useState(()=>U(e)),[j,p]=l.useState("chase"),o=l.useRef("chase");l.useEffect(()=>{o.current=j},[j]);const[d,v]=l.useState(520),s=l.useRef(c);l.useEffect(()=>{s.current=c},[c]);const x=l.useRef(!1),w=l.useRef(!1),b=l.useRef(!1),y=l.useRef(0);l.useEffect(()=>{x.current=c.running},[c.running]),l.useEffect(()=>{w.current=c.hasStarted},[c.hasStarted]),l.useEffect(()=>{const i=b.current;b.current=c.gameOver,!i&&c.gameOver&&(y.current=performance.now())},[c.gameOver]);const m=l.useRef(null),k=l.useRef(null),F=l.useRef(null),G=l.useRef(null),M=l.useRef(null),R=l.useRef(null),S=100,E=l.useRef(0),L=l.useRef(0),H=l.useCallback((i,f)=>{const u=t.current;let a=m.current;if(!a){a=new je({antialias:!0}),a.setPixelRatio(Math.min(window.devicePixelRatio,2)),a.outputColorSpace=Re,u.appendChild(a.domElement),m.current=a;const N=a.domElement;N.style.position="absolute",N.style.inset="0",N.style.width="100%",N.style.height="100%"}a.setSize(i,f);const A=a.domElement;A.style.width="100%",A.style.height="100%"},[]),$=l.useCallback(()=>{var C,O;const i=t.current,f=F.current;if(!i||!f)return;let u=i.clientWidth;!u&&i.parentElement&&(u=i.parentElement.clientWidth);const a=.62;if(!!document.fullscreenElement){const D=Math.max(1,window.innerHeight),W=Math.max(1,window.innerWidth);f.aspect=W/D,f.updateProjectionMatrix(),H(W,D),v(D),r.current&&((C=z.current)==null||C.resize(W,D));return}const N=Math.min(560,Math.floor(window.innerHeight*.8)),g=Math.max(320,Math.min(N,Math.round(u*a)));f.aspect=u/g,f.updateProjectionMatrix(),H(u,g),v(g),r.current&&((O=z.current)==null||O.resize(u,g))},[H]),z=l.useRef(null),Q=l.useCallback(()=>{h(()=>{var u;const i=U(e);q(i,e);const f=i.snake[0];return(u=G.current)==null||u.reset(f),E.current=0,L.current=performance.now(),i})},[e]);l.useEffect(()=>{var a;if(o.current!=="top")return;const i=r.current,f=t.current;if(!i||!f)return;(a=z.current)!=null&&a.dispose&&z.current.dispose(),z.current=ae(i,e);let u=f.clientWidth;!u&&f.parentElement&&(u=f.parentElement.clientWidth),z.current.resize(u,d),z.current.render(s.current)},[e,d,j]),l.useEffect(()=>{const i=f=>{const u=f.key.toLowerCase();if(u===" "){f.preventDefault(),h(a=>a.gameOver?a:a.hasStarted?{...a,running:!a.running}:{...a,hasStarted:!0,running:!0});return}if(u==="r"){const a=performance.now();if(b.current&&a-y.current<1e3)return;Q();return}u==="arrowleft"||u==="a"?h(a=>({...a,pendingDir:ce(a.dir)})):u==="arrowright"||u==="d"?h(a=>({...a,pendingDir:le(a.dir)})):u==="v"&&(p(a=>a==="chase"?"first":a==="first"?"top":"chase"),f.preventDefault())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[Q]),l.useEffect(()=>{const i=t.current;if(!i)return;const f=Se(e);k.current=f,M.current=new K(.8*e.cell,.8*e.cell,.8*e.cell),R.current=new V({color:new J("#22c55e"),metalness:0,roughness:1});const u=Ee(e);F.current=u;const a=Le(u,e);G.current=a,H(i.clientWidth,520),r.current&&(z.current=ae(r.current,e));const A=()=>$();A(),window.addEventListener("resize",A),document.addEventListener("fullscreenchange",A),h(g=>{const C={...g};return q(C,e),a.reset(C.snake[0]),C});let N=0;const X=g=>{var ne,se;N=requestAnimationFrame(X);const C=m.current,O=F.current,{scene:D,snakeGroup:W,headMesh:Z,foodMesh:de}=k.current,pe=L.current||g,me=Math.max(0,(g-pe)/1e3);L.current=g;const _=s.current;if(_.running&&_.hasStarted&&!_.gameOver&&g-E.current>=S){E.current=g;const P={..._,snake:[..._.snake]};Ce(P,e),s.current=P,h(P)}const ee=s.current.food;de.position.set(ee.x*e.cell,e.camHeight,ee.y*e.cell);const te=s.current.snake[0];if(te&&((ne=G.current)==null||ne.update(te,s.current.dir,o.current,me)),M.current&&R.current){const P=Math.max(0,s.current.snake.length-1);for(;W.children.length<P;){const T=new I(M.current,R.current);W.add(T)}for(;W.children.length>P;){const T=W.children.pop();T.geometry=new K(0,0,0)}for(let T=1;T<s.current.snake.length;T++){const re=s.current.snake[T];W.children[T-1].position.set(re.x*e.cell,.8*e.cell/2,re.y*e.cell)}}const Y=s.current.snake[0];Y&&(Z.position.set(Y.x*e.cell,.9*e.cell/2,Y.y*e.cell),Z.visible=o.current!=="first"),o.current==="top"&&((se=z.current)==null||se.render(s.current)),C.render(D,O)};return N=requestAnimationFrame(X),()=>{var C,O,D;cancelAnimationFrame(N),window.removeEventListener("resize",A),document.removeEventListener("fullscreenchange",A),(C=m.current)==null||C.dispose(),f.cleanup();const g=t.current;g&&m.current&&g.removeChild(m.current.domElement),m.current=null,(O=M.current)==null||O.dispose(),M.current=null,(D=R.current)==null||D.dispose(),R.current=null}},[e]);const ie=l.useCallback(()=>{const i=performance.now();b.current&&i-y.current<1e3||h(f=>{if(f.gameOver){const u=U(e);return q(u,e),u}return f.hasStarted?{...f,running:!f.running}:{...f,hasStarted:!0,running:!0}})},[e]),ue=l.useCallback(()=>h(i=>({...i,pendingDir:ce(i.dir)})),[]),fe=l.useCallback(()=>h(i=>({...i,pendingDir:le(i.dir)})),[]),he=l.useCallback(()=>p(i=>i==="chase"?"first":i==="first"?"top":"chase"),[]);return{mountRef:t,miniCanvasRef:r,state:c,setState:h,viewMode:j,setViewMode:p,canvasH:d,onCanvasClick:ie,onTurnLeft:ue,onTurnRight:fe,onCycleView:he}}function De(){const e=l.useMemo(()=>({cols:20,rows:20,cell:1.2,camHeight:.5}),[]),{mountRef:t,miniCanvasRef:r,state:c,viewMode:h,canvasH:j,onCanvasClick:p,onTurnLeft:o,onTurnRight:d,onCycleView:v}=He(e),s=c.running&&c.hasStarted&&!c.gameOver,x=l.useRef(null),w=l.useRef(null),[b,y]=l.useState(!1);l.useEffect(()=>{const k=()=>y(!!document.fullscreenElement);return document.addEventListener("fullscreenchange",k),()=>document.removeEventListener("fullscreenchange",k)},[]);const m=async()=>{try{if(document.fullscreenElement)document.exitFullscreen&&await document.exitFullscreen();else{const k=x.current||w.current||document.documentElement;k&&k.requestFullscreen&&await k.requestFullscreen()}}catch(k){console.warn("Fullscreen toggle failed",k)}};return n.jsx("div",{className:"space-y-3",children:n.jsxs("div",{ref:x,className:"relative",style:b?{width:"100vw",height:"100dvh"}:void 0,children:[n.jsx(Me,{height:j,show2D:h==="top",onCanvasClick:p,ref:t,miniCanvasRef:r,containerRef:w}),n.jsx(ge,{score:c.score,hasStarted:c.hasStarted,running:c.running,gameOver:c.gameOver,viewMode:h,onCycleView:v,isFullscreen:b,onToggleFullscreen:m}),n.jsxs("div",{className:`absolute inset-0 pointer-events-none ${s?"z-50":"z-0"}`,children:[n.jsx("div",{className:`absolute left-0 top-0 bottom-0 bg-transparent cursor-pointer ${s?"pointer-events-auto":"pointer-events-none"}`,style:{width:"25%"},onClick:o}),n.jsx("div",{className:`absolute right-0 top-0 bottom-0 bg-transparent cursor-pointer ${s?"pointer-events-auto":"pointer-events-none"}`,style:{width:"25%"},onClick:d})]})]})})}export{De as default};
