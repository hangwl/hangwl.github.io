(function(){"use strict";function xt(s,u){const a=s.filter((x,f)=>f!==u).map(x=>x.bid);return a.length>0?Math.max(...a):s[u].bid}function Z(s,u){const a=u.filter((f,p)=>p!==s).map(f=>f.bid),x=a.length>0?Math.max(...a):u[s].bid;return u[s].trueCtr*x}function ht(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function vt(s){if(Object.prototype.hasOwnProperty.call(s,"__esModule"))return s;var u=s.default;if(typeof u=="function"){var a=function x(){var f=!1;try{f=this instanceof x}catch{}return f?Reflect.construct(u,arguments,this.constructor):u.apply(this,arguments)};a.prototype=u.prototype}else a={};return Object.defineProperty(a,"__esModule",{value:!0}),Object.keys(s).forEach(function(x){var f=Object.getOwnPropertyDescriptor(s,x);Object.defineProperty(a,x,f.get?f:{enumerable:!0,get:function(){return s[x]}})}),a}var G={exports:{}},dt=G.exports,tt;function gt(){return tt||(tt=1,(function(s){(function(u,a,x){function f(t){var e=this,i=c();e.next=function(){var r=2091639*e.s0+e.c*23283064365386963e-26;return e.s0=e.s1,e.s1=e.s2,e.s2=r-(e.c=r|0)},e.c=1,e.s0=i(" "),e.s1=i(" "),e.s2=i(" "),e.s0-=i(t),e.s0<0&&(e.s0+=1),e.s1-=i(t),e.s1<0&&(e.s1+=1),e.s2-=i(t),e.s2<0&&(e.s2+=1),i=null}function p(t,e){return e.c=t.c,e.s0=t.s0,e.s1=t.s1,e.s2=t.s2,e}function h(t,e){var i=new f(t),r=e&&e.state,n=i.next;return n.int32=function(){return i.next()*4294967296|0},n.double=function(){return n()+(n()*2097152|0)*11102230246251565e-32},n.quick=n,r&&(typeof r=="object"&&p(r,i),n.state=function(){return p(i,{})}),n}function c(){var t=4022871197,e=function(i){i=String(i);for(var r=0;r<i.length;r++){t+=i.charCodeAt(r);var n=.02519603282416938*t;t=n>>>0,n-=t,n*=t,t=n>>>0,n-=t,t+=n*4294967296}return(t>>>0)*23283064365386963e-26};return e}a&&a.exports?a.exports=h:this.alea=h})(dt,s)})(G)),G.exports}var L={exports:{}},mt=L.exports,et;function yt(){return et||(et=1,(function(s){(function(u,a,x){function f(c){var t=this,e="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var r=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^r^r>>>8},c===(c|0)?t.x=c:e+=c;for(var i=0;i<e.length+64;i++)t.x^=e.charCodeAt(i)|0,t.next()}function p(c,t){return t.x=c.x,t.y=c.y,t.z=c.z,t.w=c.w,t}function h(c,t){var e=new f(c),i=t&&t.state,r=function(){return(e.next()>>>0)/4294967296};return r.double=function(){do var n=e.next()>>>11,o=(e.next()>>>0)/4294967296,l=(n+o)/(1<<21);while(l===0);return l},r.int32=e.next,r.quick=r,i&&(typeof i=="object"&&p(i,e),r.state=function(){return p(e,{})}),r}a&&a.exports?a.exports=h:this.xor128=h})(mt,s)})(L)),L.exports}var N={exports:{}},wt=N.exports,rt;function bt(){return rt||(rt=1,(function(s){(function(u,a,x){function f(c){var t=this,e="";t.next=function(){var r=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^(r^r<<1))|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,c===(c|0)?t.x=c:e+=c;for(var i=0;i<e.length+64;i++)t.x^=e.charCodeAt(i)|0,i==e.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function p(c,t){return t.x=c.x,t.y=c.y,t.z=c.z,t.w=c.w,t.v=c.v,t.d=c.d,t}function h(c,t){var e=new f(c),i=t&&t.state,r=function(){return(e.next()>>>0)/4294967296};return r.double=function(){do var n=e.next()>>>11,o=(e.next()>>>0)/4294967296,l=(n+o)/(1<<21);while(l===0);return l},r.int32=e.next,r.quick=r,i&&(typeof i=="object"&&p(i,e),r.state=function(){return p(e,{})}),r}a&&a.exports?a.exports=h:this.xorwow=h})(wt,s)})(N)),N.exports}var U={exports:{}},Mt=U.exports,nt;function qt(){return nt||(nt=1,(function(s){(function(u,a,x){function f(c){var t=this;t.next=function(){var i=t.x,r=t.i,n,o;return n=i[r],n^=n>>>7,o=n^n<<24,n=i[r+1&7],o^=n^n>>>10,n=i[r+3&7],o^=n^n>>>3,n=i[r+4&7],o^=n^n<<7,n=i[r+7&7],n=n^n<<13,o^=n^n<<9,i[r]=o,t.i=r+1&7,o};function e(i,r){var n,o=[];if(r===(r|0))o[0]=r;else for(r=""+r,n=0;n<r.length;++n)o[n&7]=o[n&7]<<15^r.charCodeAt(n)+o[n+1&7]<<13;for(;o.length<8;)o.push(0);for(n=0;n<8&&o[n]===0;++n);for(n==8?o[7]=-1:o[n],i.x=o,i.i=0,n=256;n>0;--n)i.next()}e(t,c)}function p(c,t){return t.x=c.x.slice(),t.i=c.i,t}function h(c,t){c==null&&(c=+new Date);var e=new f(c),i=t&&t.state,r=function(){return(e.next()>>>0)/4294967296};return r.double=function(){do var n=e.next()>>>11,o=(e.next()>>>0)/4294967296,l=(n+o)/(1<<21);while(l===0);return l},r.int32=e.next,r.quick=r,i&&(i.x&&p(i,e),r.state=function(){return p(e,{})}),r}a&&a.exports?a.exports=h:this.xorshift7=h})(Mt,s)})(U)),U.exports}var F={exports:{}},Ct=F.exports,it;function Xt(){return it||(it=1,(function(s){(function(u,a,x){function f(c){var t=this;t.next=function(){var i=t.w,r=t.X,n=t.i,o,l;return t.w=i=i+1640531527|0,l=r[n+34&127],o=r[n=n+1&127],l^=l<<13,o^=o<<17,l^=l>>>15,o^=o>>>12,l=r[n]=l^o,t.i=n,l+(i^i>>>16)|0};function e(i,r){var n,o,l,w,R,M=[],z=128;for(r===(r|0)?(o=r,r=null):(r=r+"\0",o=0,z=Math.max(z,r.length)),l=0,w=-32;w<z;++w)r&&(o^=r.charCodeAt((w+32)%r.length)),w===0&&(R=o),o^=o<<10,o^=o>>>15,o^=o<<4,o^=o>>>13,w>=0&&(R=R+1640531527|0,n=M[w&127]^=o+R,l=n==0?l+1:0);for(l>=128&&(M[(r&&r.length||0)&127]=-1),l=127,w=512;w>0;--w)o=M[l+34&127],n=M[l=l+1&127],o^=o<<13,n^=n<<17,o^=o>>>15,n^=n>>>12,M[l]=o^n;i.w=R,i.X=M,i.i=l}e(t,c)}function p(c,t){return t.i=c.i,t.w=c.w,t.X=c.X.slice(),t}function h(c,t){c==null&&(c=+new Date);var e=new f(c),i=t&&t.state,r=function(){return(e.next()>>>0)/4294967296};return r.double=function(){do var n=e.next()>>>11,o=(e.next()>>>0)/4294967296,l=(n+o)/(1<<21);while(l===0);return l},r.int32=e.next,r.quick=r,i&&(i.X&&p(i,e),r.state=function(){return p(e,{})}),r}a&&a.exports?a.exports=h:this.xor4096=h})(Ct,s)})(F)),F.exports}var V={exports:{}},Rt=V.exports,ot;function jt(){return ot||(ot=1,(function(s){(function(u,a,x){function f(c){var t=this,e="";t.next=function(){var r=t.b,n=t.c,o=t.d,l=t.a;return r=r<<25^r>>>7^n,n=n-o|0,o=o<<24^o>>>8^l,l=l-r|0,t.b=r=r<<20^r>>>12^n,t.c=n=n-o|0,t.d=o<<16^n>>>16^l,t.a=l-r|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,c===Math.floor(c)?(t.a=c/4294967296|0,t.b=c|0):e+=c;for(var i=0;i<e.length+20;i++)t.b^=e.charCodeAt(i)|0,t.next()}function p(c,t){return t.a=c.a,t.b=c.b,t.c=c.c,t.d=c.d,t}function h(c,t){var e=new f(c),i=t&&t.state,r=function(){return(e.next()>>>0)/4294967296};return r.double=function(){do var n=e.next()>>>11,o=(e.next()>>>0)/4294967296,l=(n+o)/(1<<21);while(l===0);return l},r.int32=e.next,r.quick=r,i&&(typeof i=="object"&&p(i,e),r.state=function(){return p(e,{})}),r}a&&a.exports?a.exports=h:this.tychei=h})(Rt,s)})(V)),V.exports}var W={exports:{}},Et={},_t=Object.freeze({__proto__:null,default:Et}),kt=vt(_t),Pt=W.exports,at;function St(){return at||(at=1,(function(s){(function(u,a,x){var f=256,p=6,h=52,c="random",t=x.pow(f,p),e=x.pow(2,h),i=e*2,r=f-1,n;function o(v,d,b){var y=[];d=d==!0?{entropy:!0}:d||{};var m=M(R(d.entropy?[v,T(a)]:v??z(),3),y),q=new l(y),X=function(){for(var C=q.g(p),_=t,j=0;C<e;)C=(C+j)*f,_*=f,j=q.g(1);for(;C>=i;)C/=2,_/=2,j>>>=1;return(C+j)/_};return X.int32=function(){return q.g(4)|0},X.quick=function(){return q.g(4)/4294967296},X.double=X,M(T(q.S),a),(d.pass||b||function(C,_,j,P){return P&&(P.S&&w(P,q),C.state=function(){return w(q,{})}),j?(x[c]=C,_):C})(X,m,"global"in d?d.global:this==x,d.state)}function l(v){var d,b=v.length,y=this,m=0,q=y.i=y.j=0,X=y.S=[];for(b||(v=[b++]);m<f;)X[m]=m++;for(m=0;m<f;m++)X[m]=X[q=r&q+v[m%b]+(d=X[m])],X[q]=d;(y.g=function(C){for(var _,j=0,P=y.i,H=y.j,D=y.S;C--;)_=D[P=r&P+1],j=j*f+D[r&(D[P]=D[H=r&H+_])+(D[H]=_)];return y.i=P,y.j=H,j})(f)}function w(v,d){return d.i=v.i,d.j=v.j,d.S=v.S.slice(),d}function R(v,d){var b=[],y=typeof v,m;if(d&&y=="object")for(m in v)try{b.push(R(v[m],d-1))}catch{}return b.length?b:y=="string"?v:v+"\0"}function M(v,d){for(var b=v+"",y,m=0;m<b.length;)d[r&m]=r&(y^=d[r&m]*19)+b.charCodeAt(m++);return T(d)}function z(){try{var v;return n&&(v=n.randomBytes)?v=v(f):(v=new Uint8Array(f),(u.crypto||u.msCrypto).getRandomValues(v)),T(v)}catch{var d=u.navigator,b=d&&d.plugins;return[+new Date,u,b,u.screen,T(a)]}}function T(v){return String.fromCharCode.apply(0,v)}if(M(x.random(),a),s.exports){s.exports=o;try{n=kt}catch{}}else x["seed"+c]=o})(typeof self<"u"?self:Pt,[],Math)})(W)),W.exports}var J,ct;function Bt(){if(ct)return J;ct=1;var s=gt(),u=yt(),a=bt(),x=qt(),f=Xt(),p=jt(),h=St();return h.alea=s,h.xor128=u,h.xorwow=a,h.xorshift7=x,h.xor4096=f,h.tychei=p,J=h,J}var At=Bt(),$t=ht(At);let g=[],S=null,st=500,ut=!1,ft=1,K=null,lt=!1,Q=0,B=0,A=0,$=0,I=0,O=0;const E={ctr:{muBase:.05,amp:.01,period:2e3,phi:.98,sigma:.002},bid:{muBase:1,amp:.1,phi:.99,sigma:.02}};function k(){return K?K():Math.random()}function pt(s,u){return k()*(u-s)+s}function It(s){const u=[];for(let a=0;a<s;a++)u.push({id:a,trueCtr:pt(.01,.1),bid:pt(.1,2),alpha:1,beta:1,clicks:0,impressions:0,revenue:0,cpc:0});return u}function Ot(s,u){function a(p){if(p<1){const t=k();return a(1+p)*Math.pow(t,1/p)}const h=p-1/3,c=1/Math.sqrt(9*h);for(;;){let t,e;do{const r=k(),n=k();t=Math.sqrt(-2*Math.log(r))*Math.cos(2*Math.PI*n),e=1+c*t}while(e<=0);const i=k();if(i<1-.0331*t*t*t*t||Math.log(i)<.5*t*t+h*(1-e+Math.log(e)))return h*e}}const x=a(s),f=a(u);return x/(x+f)}function zt(s){let u=0,a=-1/0;for(let x=0;x<s.length;x++){const f=Ot(s[x].alpha,s[x].beta);f>a&&(a=f,u=x)}return u}function Tt(){if(!g||g.length===0)return null;const s=zt(g),u=g[s],a=xt(g,s);u.cpc=a;const x=k()<u.trueCtr;if(u.impressions+=1,Q>0){const t=1-Q;for(let e=0;e<g.length;e++)g[e].alpha=Math.max(.001,g[e].alpha*t),g[e].beta=Math.max(.001,g[e].beta*t)}if(x?(u.clicks+=1,u.revenue+=u.cpc,u.alpha+=1):u.beta+=1,B+=1,A=g.reduce((t,e)=>t+e.revenue,0),lt){const t=B,e=Math.sin(2*Math.PI*t/E.ctr.period),i=E.ctr.muBase+E.ctr.amp*e,r=E.bid.muBase+E.bid.amp*e;for(let n=0;n<g.length;n++){const o=g[n],l=(k()-.5)*2,w=(k()-.5)*2,R=i+E.ctr.phi*(o.trueCtr-i)+E.ctr.sigma*l,M=r+E.bid.phi*(o.bid-r)+E.bid.sigma*w;o.trueCtr=Math.min(.5,Math.max(.001,R)),o.bid=Math.min(5,Math.max(.05,M))}}let f=-1,p=0;for(let t=0;t<g.length;t++){const e=Z(t,g);e>f&&(f=e,p=t)}const h=s===p?"EXPLOIT":"EXPLORE";$+=Math.max(0,f);const c=Math.max(0,Z(s,g));return I+=Math.max(0,f),O+=c,{winnerIdx:s,clicked:x,status:h,cpcPrice:a,totals:{totalIterations:B,totalRevenue:A,perfectTotalRevenue:$,regret:Math.max(0,$-A),perfectTotalExpected:I,chosenTotalExpected:O,expectedRegret:Math.max(0,I-O)},ads:g.map(t=>({id:t.id,trueCtr:t.trueCtr,bid:t.bid,cpc:t.cpc,alpha:t.alpha,beta:t.beta,clicks:t.clicks,impressions:t.impressions,revenue:t.revenue}))}}function Dt(){S&&clearInterval(S),S=setInterval(()=>{let s=null;for(let u=0;u<Math.max(1,ft);u++){const a=Tt();a&&(s=a)}s&&self.postMessage({type:"tick",payload:s}),ut||Y()},st)}function Y(){S&&(clearInterval(S),S=null)}self.onmessage=s=>{const{type:u,payload:a}=s.data||{};switch(u){case"init":{const x=a?.numAds??5,f=a?.seed;K=f?$t(f):null,lt=!!a?.dynamicEnv,g=It(x),B=0,A=0,$=0,I=0,O=0,self.postMessage({type:"ready",payload:{numAds:g.length,ads:g.map(p=>({id:p.id,trueCtr:p.trueCtr,bid:p.bid,cpc:p.cpc,alpha:p.alpha,beta:p.beta,clicks:p.clicks,impressions:p.impressions,revenue:p.revenue})),totals:{totalIterations:B,totalRevenue:A,perfectTotalRevenue:0,regret:0}}});break}case"start":{ut=!!a?.continuous,ft=Math.max(1,Number(a?.stepsPerTick??1)),st=Math.max(10,Math.floor((a?.speedSec??.5)*1e3)),Q=Math.min(1,Math.max(0,Number(a?.decay??0))),Dt();break}case"pause":{Y();break}case"reset":{Y(),g=[],B=0,A=0,$=0,I=0,O=0,self.postMessage({type:"reset_done"});break}case"ping":{self.postMessage({type:"pong",payload:{t:Date.now()}});break}default:self.postMessage({type:"unknown",payload:{received:{type:u,payload:a}}})}}})();
