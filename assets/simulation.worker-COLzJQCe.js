(function(){"use strict";function pt(s,u){const i=s.filter((p,f)=>f!==u).map(p=>p.bid);return i.length>0?Math.max(...i):s[u].bid}function Z(s,u){const i=u.filter((f,x)=>x!==s).map(f=>f.bid),p=i.length>0?Math.max(...i):u[s].bid;return u[s].trueCtr*p}function ht(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function vt(s){if(Object.prototype.hasOwnProperty.call(s,"__esModule"))return s;var u=s.default;if(typeof u=="function"){var i=function p(){return this instanceof p?Reflect.construct(u,arguments,this.constructor):u.apply(this,arguments)};i.prototype=u.prototype}else i={};return Object.defineProperty(i,"__esModule",{value:!0}),Object.keys(s).forEach(function(p){var f=Object.getOwnPropertyDescriptor(s,p);Object.defineProperty(i,p,f.get?f:{enumerable:!0,get:function(){return s[p]}})}),i}var G={exports:{}},dt=G.exports,tt;function gt(){return tt||(tt=1,function(s){(function(u,i,p){function f(t){var e=this,o=c();e.next=function(){var r=2091639*e.s0+e.c*23283064365386963e-26;return e.s0=e.s1,e.s1=e.s2,e.s2=r-(e.c=r|0)},e.c=1,e.s0=o(" "),e.s1=o(" "),e.s2=o(" "),e.s0-=o(t),e.s0<0&&(e.s0+=1),e.s1-=o(t),e.s1<0&&(e.s1+=1),e.s2-=o(t),e.s2<0&&(e.s2+=1),o=null}function x(t,e){return e.c=t.c,e.s0=t.s0,e.s1=t.s1,e.s2=t.s2,e}function h(t,e){var o=new f(t),r=e&&e.state,n=o.next;return n.int32=function(){return o.next()*4294967296|0},n.double=function(){return n()+(n()*2097152|0)*11102230246251565e-32},n.quick=n,r&&(typeof r=="object"&&x(r,o),n.state=function(){return x(o,{})}),n}function c(){var t=4022871197,e=function(o){o=String(o);for(var r=0;r<o.length;r++){t+=o.charCodeAt(r);var n=.02519603282416938*t;t=n>>>0,n-=t,n*=t,t=n>>>0,n-=t,t+=n*4294967296}return(t>>>0)*23283064365386963e-26};return e}i&&i.exports?i.exports=h:this.alea=h})(dt,s)}(G)),G.exports}var L={exports:{}},mt=L.exports,et;function wt(){return et||(et=1,function(s){(function(u,i,p){function f(c){var t=this,e="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var r=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^r^r>>>8},c===(c|0)?t.x=c:e+=c;for(var o=0;o<e.length+64;o++)t.x^=e.charCodeAt(o)|0,t.next()}function x(c,t){return t.x=c.x,t.y=c.y,t.z=c.z,t.w=c.w,t}function h(c,t){var e=new f(c),o=t&&t.state,r=function(){return(e.next()>>>0)/4294967296};return r.double=function(){do var n=e.next()>>>11,a=(e.next()>>>0)/4294967296,l=(n+a)/(1<<21);while(l===0);return l},r.int32=e.next,r.quick=r,o&&(typeof o=="object"&&x(o,e),r.state=function(){return x(e,{})}),r}i&&i.exports?i.exports=h:this.xor128=h})(mt,s)}(L)),L.exports}var N={exports:{}},bt=N.exports,rt;function yt(){return rt||(rt=1,function(s){(function(u,i,p){function f(c){var t=this,e="";t.next=function(){var r=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^(r^r<<1))|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,c===(c|0)?t.x=c:e+=c;for(var o=0;o<e.length+64;o++)t.x^=e.charCodeAt(o)|0,o==e.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function x(c,t){return t.x=c.x,t.y=c.y,t.z=c.z,t.w=c.w,t.v=c.v,t.d=c.d,t}function h(c,t){var e=new f(c),o=t&&t.state,r=function(){return(e.next()>>>0)/4294967296};return r.double=function(){do var n=e.next()>>>11,a=(e.next()>>>0)/4294967296,l=(n+a)/(1<<21);while(l===0);return l},r.int32=e.next,r.quick=r,o&&(typeof o=="object"&&x(o,e),r.state=function(){return x(e,{})}),r}i&&i.exports?i.exports=h:this.xorwow=h})(bt,s)}(N)),N.exports}var U={exports:{}},Mt=U.exports,nt;function qt(){return nt||(nt=1,function(s){(function(u,i,p){function f(c){var t=this;t.next=function(){var o=t.x,r=t.i,n,a;return n=o[r],n^=n>>>7,a=n^n<<24,n=o[r+1&7],a^=n^n>>>10,n=o[r+3&7],a^=n^n>>>3,n=o[r+4&7],a^=n^n<<7,n=o[r+7&7],n=n^n<<13,a^=n^n<<9,o[r]=a,t.i=r+1&7,a};function e(o,r){var n,a=[];if(r===(r|0))a[0]=r;else for(r=""+r,n=0;n<r.length;++n)a[n&7]=a[n&7]<<15^r.charCodeAt(n)+a[n+1&7]<<13;for(;a.length<8;)a.push(0);for(n=0;n<8&&a[n]===0;++n);for(n==8?a[7]=-1:a[n],o.x=a,o.i=0,n=256;n>0;--n)o.next()}e(t,c)}function x(c,t){return t.x=c.x.slice(),t.i=c.i,t}function h(c,t){c==null&&(c=+new Date);var e=new f(c),o=t&&t.state,r=function(){return(e.next()>>>0)/4294967296};return r.double=function(){do var n=e.next()>>>11,a=(e.next()>>>0)/4294967296,l=(n+a)/(1<<21);while(l===0);return l},r.int32=e.next,r.quick=r,o&&(o.x&&x(o,e),r.state=function(){return x(e,{})}),r}i&&i.exports?i.exports=h:this.xorshift7=h})(Mt,s)}(U)),U.exports}var F={exports:{}},Ct=F.exports,it;function Xt(){return it||(it=1,function(s){(function(u,i,p){function f(c){var t=this;t.next=function(){var o=t.w,r=t.X,n=t.i,a,l;return t.w=o=o+1640531527|0,l=r[n+34&127],a=r[n=n+1&127],l^=l<<13,a^=a<<17,l^=l>>>15,a^=a>>>12,l=r[n]=l^a,t.i=n,l+(o^o>>>16)|0};function e(o,r){var n,a,l,b,R,M=[],z=128;for(r===(r|0)?(a=r,r=null):(r=r+"\0",a=0,z=Math.max(z,r.length)),l=0,b=-32;b<z;++b)r&&(a^=r.charCodeAt((b+32)%r.length)),b===0&&(R=a),a^=a<<10,a^=a>>>15,a^=a<<4,a^=a>>>13,b>=0&&(R=R+1640531527|0,n=M[b&127]^=a+R,l=n==0?l+1:0);for(l>=128&&(M[(r&&r.length||0)&127]=-1),l=127,b=4*128;b>0;--b)a=M[l+34&127],n=M[l=l+1&127],a^=a<<13,n^=n<<17,a^=a>>>15,n^=n>>>12,M[l]=a^n;o.w=R,o.X=M,o.i=l}e(t,c)}function x(c,t){return t.i=c.i,t.w=c.w,t.X=c.X.slice(),t}function h(c,t){c==null&&(c=+new Date);var e=new f(c),o=t&&t.state,r=function(){return(e.next()>>>0)/4294967296};return r.double=function(){do var n=e.next()>>>11,a=(e.next()>>>0)/4294967296,l=(n+a)/(1<<21);while(l===0);return l},r.int32=e.next,r.quick=r,o&&(o.X&&x(o,e),r.state=function(){return x(e,{})}),r}i&&i.exports?i.exports=h:this.xor4096=h})(Ct,s)}(F)),F.exports}var V={exports:{}},Rt=V.exports,ot;function jt(){return ot||(ot=1,function(s){(function(u,i,p){function f(c){var t=this,e="";t.next=function(){var r=t.b,n=t.c,a=t.d,l=t.a;return r=r<<25^r>>>7^n,n=n-a|0,a=a<<24^a>>>8^l,l=l-r|0,t.b=r=r<<20^r>>>12^n,t.c=n=n-a|0,t.d=a<<16^n>>>16^l,t.a=l-r|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,c===Math.floor(c)?(t.a=c/4294967296|0,t.b=c|0):e+=c;for(var o=0;o<e.length+20;o++)t.b^=e.charCodeAt(o)|0,t.next()}function x(c,t){return t.a=c.a,t.b=c.b,t.c=c.c,t.d=c.d,t}function h(c,t){var e=new f(c),o=t&&t.state,r=function(){return(e.next()>>>0)/4294967296};return r.double=function(){do var n=e.next()>>>11,a=(e.next()>>>0)/4294967296,l=(n+a)/(1<<21);while(l===0);return l},r.int32=e.next,r.quick=r,o&&(typeof o=="object"&&x(o,e),r.state=function(){return x(e,{})}),r}i&&i.exports?i.exports=h:this.tychei=h})(Rt,s)}(V)),V.exports}var W={exports:{}},Et={},_t=Object.freeze({__proto__:null,default:Et}),kt=vt(_t),Pt=W.exports,at;function St(){return at||(at=1,function(s){(function(u,i,p){var f=256,x=6,h=52,c="random",t=p.pow(f,x),e=p.pow(2,h),o=e*2,r=f-1,n;function a(v,d,y){var w=[];d=d==!0?{entropy:!0}:d||{};var m=M(R(d.entropy?[v,T(i)]:v??z(),3),w),q=new l(w),X=function(){for(var C=q.g(x),_=t,j=0;C<e;)C=(C+j)*f,_*=f,j=q.g(1);for(;C>=o;)C/=2,_/=2,j>>>=1;return(C+j)/_};return X.int32=function(){return q.g(4)|0},X.quick=function(){return q.g(4)/4294967296},X.double=X,M(T(q.S),i),(d.pass||y||function(C,_,j,P){return P&&(P.S&&b(P,q),C.state=function(){return b(q,{})}),j?(p[c]=C,_):C})(X,m,"global"in d?d.global:this==p,d.state)}function l(v){var d,y=v.length,w=this,m=0,q=w.i=w.j=0,X=w.S=[];for(y||(v=[y++]);m<f;)X[m]=m++;for(m=0;m<f;m++)X[m]=X[q=r&q+v[m%y]+(d=X[m])],X[q]=d;(w.g=function(C){for(var _,j=0,P=w.i,H=w.j,D=w.S;C--;)_=D[P=r&P+1],j=j*f+D[r&(D[P]=D[H=r&H+_])+(D[H]=_)];return w.i=P,w.j=H,j})(f)}function b(v,d){return d.i=v.i,d.j=v.j,d.S=v.S.slice(),d}function R(v,d){var y=[],w=typeof v,m;if(d&&w=="object")for(m in v)try{y.push(R(v[m],d-1))}catch{}return y.length?y:w=="string"?v:v+"\0"}function M(v,d){for(var y=v+"",w,m=0;m<y.length;)d[r&m]=r&(w^=d[r&m]*19)+y.charCodeAt(m++);return T(d)}function z(){try{var v;return n&&(v=n.randomBytes)?v=v(f):(v=new Uint8Array(f),(u.crypto||u.msCrypto).getRandomValues(v)),T(v)}catch{var d=u.navigator,y=d&&d.plugins;return[+new Date,u,y,u.screen,T(i)]}}function T(v){return String.fromCharCode.apply(0,v)}if(M(p.random(),i),s.exports){s.exports=a;try{n=kt}catch{}}else p["seed"+c]=a})(typeof self<"u"?self:Pt,[],Math)}(W)),W.exports}var J,ct;function Bt(){if(ct)return J;ct=1;var s=gt(),u=wt(),i=yt(),p=qt(),f=Xt(),x=jt(),h=St();return h.alea=s,h.xor128=u,h.xorwow=i,h.xorshift7=p,h.xor4096=f,h.tychei=x,J=h,J}var At=Bt(),$t=ht(At);let g=[],S=null,st=500,ut=!1,ft=1,K=null,lt=!1,Q=0,B=0,A=0,$=0,O=0,I=0;const E={ctr:{muBase:.05,amp:.01,period:2e3,phi:.98,sigma:.002},bid:{muBase:1,amp:.1,phi:.99,sigma:.02}};function k(){return K?K():Math.random()}function xt(s,u){return k()*(u-s)+s}function Ot(s){const u=[];for(let i=0;i<s;i++)u.push({id:i,trueCtr:xt(.01,.1),bid:xt(.1,2),alpha:1,beta:1,clicks:0,impressions:0,revenue:0,cpc:0});return u}function It(s,u){function i(x){if(x<1){const t=k();return i(1+x)*Math.pow(t,1/x)}const h=x-1/3,c=1/Math.sqrt(9*h);for(;;){let t,e;do{const r=k(),n=k();t=Math.sqrt(-2*Math.log(r))*Math.cos(2*Math.PI*n),e=1+c*t}while(e<=0);const o=k();if(o<1-.0331*t*t*t*t||Math.log(o)<.5*t*t+h*(1-e+Math.log(e)))return h*e}}const p=i(s),f=i(u);return p/(p+f)}function zt(s){let u=0,i=-1/0;for(let p=0;p<s.length;p++){const f=It(s[p].alpha,s[p].beta);f>i&&(i=f,u=p)}return u}function Tt(){if(!g||g.length===0)return null;const s=zt(g),u=g[s],i=pt(g,s);u.cpc=i;const p=k()<u.trueCtr;if(u.impressions+=1,Q>0){const t=1-Q;for(let e=0;e<g.length;e++)g[e].alpha=Math.max(.001,g[e].alpha*t),g[e].beta=Math.max(.001,g[e].beta*t)}if(p?(u.clicks+=1,u.revenue+=u.cpc,u.alpha+=1):u.beta+=1,B+=1,A=g.reduce((t,e)=>t+e.revenue,0),lt){const t=B,e=Math.sin(2*Math.PI*t/E.ctr.period),o=E.ctr.muBase+E.ctr.amp*e,r=E.bid.muBase+E.bid.amp*e;for(let n=0;n<g.length;n++){const a=g[n],l=(k()-.5)*2,b=(k()-.5)*2,R=o+E.ctr.phi*(a.trueCtr-o)+E.ctr.sigma*l,M=r+E.bid.phi*(a.bid-r)+E.bid.sigma*b;a.trueCtr=Math.min(.5,Math.max(.001,R)),a.bid=Math.min(5,Math.max(.05,M))}}let f=-1,x=0;for(let t=0;t<g.length;t++){const e=Z(t,g);e>f&&(f=e,x=t)}const h=s===x?"EXPLOIT":"EXPLORE";$+=Math.max(0,f);const c=Math.max(0,Z(s,g));return O+=Math.max(0,f),I+=c,{winnerIdx:s,clicked:p,status:h,cpcPrice:i,totals:{totalIterations:B,totalRevenue:A,perfectTotalRevenue:$,regret:Math.max(0,$-A),perfectTotalExpected:O,chosenTotalExpected:I,expectedRegret:Math.max(0,O-I)},ads:g.map(t=>({id:t.id,trueCtr:t.trueCtr,bid:t.bid,cpc:t.cpc,alpha:t.alpha,beta:t.beta,clicks:t.clicks,impressions:t.impressions,revenue:t.revenue}))}}function Dt(){S&&clearInterval(S),S=setInterval(()=>{let s=null;for(let u=0;u<Math.max(1,ft);u++){const i=Tt();i&&(s=i)}s&&self.postMessage({type:"tick",payload:s}),ut||Y()},st)}function Y(){S&&(clearInterval(S),S=null)}self.onmessage=s=>{const{type:u,payload:i}=s.data||{};switch(u){case"init":{const p=(i==null?void 0:i.numAds)??5,f=i==null?void 0:i.seed;K=f?$t(f):null,lt=!!(i!=null&&i.dynamicEnv),g=Ot(p),B=0,A=0,$=0,O=0,I=0,self.postMessage({type:"ready",payload:{numAds:g.length,ads:g.map(x=>({id:x.id,trueCtr:x.trueCtr,bid:x.bid,cpc:x.cpc,alpha:x.alpha,beta:x.beta,clicks:x.clicks,impressions:x.impressions,revenue:x.revenue})),totals:{totalIterations:B,totalRevenue:A,perfectTotalRevenue:0,regret:0}}});break}case"start":{ut=!!(i!=null&&i.continuous),ft=Math.max(1,Number((i==null?void 0:i.stepsPerTick)??1)),st=Math.max(10,Math.floor(((i==null?void 0:i.speedSec)??.5)*1e3)),Q=Math.min(1,Math.max(0,Number((i==null?void 0:i.decay)??0))),Dt();break}case"pause":{Y();break}case"reset":{Y(),g=[],B=0,A=0,$=0,O=0,I=0,self.postMessage({type:"reset_done"});break}case"ping":{self.postMessage({type:"pong",payload:{t:Date.now()}});break}default:self.postMessage({type:"unknown",payload:{received:{type:u,payload:i}}})}}})();
